<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>EV Analytics | ML Models</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="style.css">
    <style>
        :root {
            --sidebar-width: 260px;
            --primary-color: #6366f1;
            --sidebar-bg: #0f172a;
            --content-bg: #f8fafc;
        }

        body {
            background: var(--content-bg);
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            margin: 0;
            display: flex;
        }

        /* Sidebar Styles */
        .sidebar {
            width: var(--sidebar-width);
            height: 100vh;
            background: var(--sidebar-bg);
            color: #cbd5e1;
            position: fixed;
            left: 0;
            top: 0;
            display: flex;
            flex-direction: column;
            padding: 1.5rem;
            z-index: 1000;
            box-shadow: 4px 0 10px rgba(0, 0, 0, 0.1);
        }

        .sidebar-brand {
            font-size: 1.25rem;
            font-weight: 700;
            color: white;
            margin-bottom: 2rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .nav-links {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            flex-grow: 1;
        }

        .nav-link-custom {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 0.75rem 1rem;
            color: #94a3b8;
            text-decoration: none;
            border-radius: 8px;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .nav-link-custom:hover {
            background: rgba(255, 255, 255, 0.05);
            color: white;
        }

        .nav-link-custom.active {
            background: var(--primary-color);
            color: white;
        }

        .logout-btn-nav {
            margin-top: auto;
            background: rgba(239, 68, 68, 0.1);
            color: #f87171;
            border: 1px solid rgba(239, 68, 68, 0.2);
            padding: 0.75rem 1rem;
            display: flex;
            align-items: center;
            gap: 12px;
            width: 100%;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
        }

        .logout-btn-nav:hover {
            background: #ef4444;
            color: white;
        }

        /* Main Content Area */
        .main-content {
            margin-left: var(--sidebar-width);
            flex-grow: 1;
            padding: 2rem;
            min-height: 100vh;
        }

        .card-custom {
            background: white;
            border: none;
            border-radius: 16px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            padding: 1.5rem;
            transition: transform 0.2s ease;
        }

        .card-custom:hover {
            transform: translateY(-2px);
        }

        .card-custom:hover {
            transform: translateY(-2px);
        }

        /* ML Model Style Enhancements */
        .ml-card {
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid rgba(99, 102, 241, 0.1);
            border-radius: 20px;
            padding: 2rem;
            height: 100%;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
        }

        .ml-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 25px -5px rgba(99, 102, 241, 0.15), 0 8px 10px -6px rgba(99, 102, 241, 0.1);
            border-color: rgba(99, 102, 241, 0.3);
        }

        .ml-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, #6366f1, #8b5cf6);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .ml-card:hover::before {
            opacity: 1;
        }

        .ml-icon-wrapper {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(139, 92, 246, 0.1));
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.75rem;
            margin-bottom: 1.5rem;
            color: #6366f1;
        }

        .ml-card h3 {
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 0.75rem;
        }

        .ml-card p {
            color: #64748b;
            margin-bottom: 2rem;
            line-height: 1.6;
        }

        .btn-predict {
            width: 100%;
            padding: 0.875rem;
            border-radius: 12px;
            font-weight: 600;
            background: linear-gradient(135deg, #6366f1, #4f46e5);
            color: white;
            border: none;
            transition: all 0.2s ease;
        }

        .btn-predict:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
            background: linear-gradient(135deg, #4f46e5, #4338ca);
        }

        .form-section {
            background: white;
            border-radius: 24px;
            padding: 2.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.05);
            margin-top: 2rem;
            border: 1px solid rgba(226, 232, 240, 0.8);
            animation: slideDown 0.4s ease-out;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .form-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #f1f5f9;
        }

        .form-control-custom {
            background-color: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 10px;
            padding: 0.75rem 1rem;
            transition: all 0.2s;
        }

        .form-control-custom:focus {
            background-color: white;
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
            outline: none;
        }

        .form-label {
            font-weight: 500;
            color: #475569;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }

        .btn-close-form {
            background: #f1f5f9;
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #64748b;
            transition: all 0.2s;
        }

        .btn-close-form:hover {
            background: #e2e8f0;
            color: #ef4444;
            transform: rotate(90deg);
        }

        /* ===== Interactive Battery Result Styles ===== */
        @keyframes pulseRing {

            0%,
            100% {
                transform: scale(1);
                opacity: 0.8;
            }

            50% {
                transform: scale(1.12);
                opacity: 0.4;
            }
        }

        @keyframes fadeSlideUp {
            from {
                opacity: 0;
                transform: translateY(24px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes barFill {
            from {
                width: 0%;
            }
        }

        @keyframes counterUp {
            from {
                opacity: 0;
                transform: translateY(8px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .bh-result-wrapper {
            animation: fadeSlideUp 0.5s ease forwards;
        }

        .bh-status-orb {
            width: 130px;
            height: 130px;
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1rem;
            font-size: 2.4rem;
            font-weight: 800;
            position: relative;
            color: white;
            box-shadow: 0 0 0 0 rgba(0, 0, 0, 0.2);
        }

        .bh-status-orb::before {
            content: '';
            position: absolute;
            inset: -10px;
            border-radius: 50%;
            opacity: 0.25;
            animation: pulseRing 2s ease-in-out infinite;
            background: inherit;
        }

        .bh-status-label {
            font-size: 0.75rem;
            font-weight: 600;
            letter-spacing: 1px;
            text-transform: uppercase;
            margin-top: 2px;
        }

        .bh-metric-bar {
            height: 8px;
            border-radius: 8px;
            background: #e2e8f0;
            overflow: hidden;
            margin-top: 6px;
        }

        .bh-metric-fill {
            height: 100%;
            border-radius: 8px;
            width: 0;
            transition: width 1.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .bh-card {
            background: white;
            border-radius: 16px;
            border: 1px solid #f1f5f9;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.06);
            padding: 1.2rem 1.5rem;
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.5s ease, transform 0.5s ease;
        }

        .bh-card.visible {
            opacity: 1;
            transform: translateY(0);
        }

        .bh-risk-bar {
            height: 14px;
            border-radius: 10px;
            background: linear-gradient(90deg, #10b981 0%, #f59e0b 50%, #ef4444 100%);
            position: relative;
            margin-top: 10px;
        }

        .bh-risk-marker {
            width: 22px;
            height: 22px;
            border-radius: 50%;
            background: white;
            border: 3px solid #334155;
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            transition: left 1.2s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }
    </style>
</head>

<body>

    <!-- SIDEBAR NAVIGATION -->
    <aside class="sidebar">
        <div class="sidebar-brand">
            <span>‚ö° Volt Analytics</span>
        </div>
        <div class="nav-links">
            <a href="user-dashboard.html" class="nav-link-custom">
                <span>üìä</span> Dashboard
            </a>
            <a href="ml_models.html" class="nav-link-custom active">
                <span>ü§ñ</span> ML Models
            </a>
            <a href="index.html" class="nav-link-custom">
                <span>üè†</span> Home
            </a>
            <button class="nav-link-custom logout-btn-nav mt-auto" onclick="logout()">
                <span>üö™</span> Logout
            </button>
        </div>
    </aside>

    <!-- MAIN CONTENT -->
    <main class="main-content">
        <div class="row align-items-center mb-4">
            <div class="col">
                <h2 class="fw-bold mb-0" style="color: black;">Advanced ML Models</h2>
                <p class="text-muted">Explore our predictive analytics powered by machine learning.</p>
            </div>
        </div>

        <!-- Prediction Cards Row -->
        <div class="row g-4 mb-5">
            <!-- Battery Health Card -->
            <div class="col-md-6">
                <div class="ml-card">
                    <div class="ml-icon-wrapper">
                        üîã
                    </div>
                    <h3>Battery Health Prediction</h3>
                    <p>Analyze your EV battery's current state and predict its remaining lifespan using our advanced AI
                        algorithm considering charge cycles, voltage, and temperature.</p>
                    <button class="btn-predict" onclick="showForm('battery')">Predict Health</button>
                </div>
            </div>

            <!-- Value for Money Card -->
            <div class="col-md-6">
                <div class="ml-card">
                    <div class="ml-icon-wrapper">
                        üíé
                    </div>
                    <h3>Value for Money Prediction</h3>
                    <p>Get an accurate valuation of your EV based on market trends, depreciation curves, and vehicle
                        condition. Perfect for resale or purchase decisions.</p>
                    <button class="btn-predict" onclick="showForm('value')">Check Value</button>
                </div>
            </div>
        </div>

        <!-- Sales Forecast Card -->
        <div class="row g-4 mb-5">
            <div class="col-12">
                <div class="ml-card">
                    <div class="d-flex align-items-center mb-3">
                        <div class="ml-icon-wrapper mb-0 me-3">
                            üìà
                        </div>
                        <div>
                            <h3 class="mb-1">EV Sales Forecasting</h3>
                            <p class="mb-0 text-muted">Predict future EV sales trends using historical data.</p>
                        </div>
                    </div>
                    <button class="btn-predict" onclick="showForm('sales')">View Forecast</button>
                </div>
            </div>
        </div>

        <!-- Battery Health Form Section -->
        <div id="batteryFormSection" class="form-section d-none">
            <div class="form-header">
                <div>
                    <h3 class="fw-bold mb-1">Battery Health Analysis</h3>
                    <p class="text-muted mb-0">Enter technical parameters for precise health estimation</p>
                </div>
                <button class="btn-close-form" onclick="closeForms()">‚úï</button>
            </div>
            <form id="batteryHealthForm">
                <div class="row g-4">
                    <div class="col-md-6">
                        <label class="form-label">Vehicle Age (years)</label>
                        <input type="number" class="form-control form-control-custom" name="vehicle_age_years"
                            step="0.1" placeholder="e.g. 1" required>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Total Charge Cycles</label>
                        <input type="number" class="form-control form-control-custom" name="total_charge_cycles"
                            placeholder="e.g. 326" required>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Max Battery Temperature (¬∞C)</label>
                        <input type="number" class="form-control form-control-custom" name="max_battery_temperature_c"
                            step="0.1" placeholder="e.g. 36" required>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Avg Battery Temperature (¬∞C)</label>
                        <input type="number" class="form-control form-control-custom" name="avg_battery_temperature_c"
                            step="0.1" placeholder="e.g. 26" required>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Avg Charging Time (hours)</label>
                        <input type="number" class="form-control form-control-custom" name="avg_charging_time_hours"
                            step="0.1" placeholder="e.g. 2" required>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Avg Depth of Discharge (%)</label>
                        <input type="number" class="form-control form-control-custom"
                            name="avg_depth_of_discharge_percent" step="0.1" placeholder="e.g. 56" required>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Fast Charging Frequency (%)</label>
                        <input type="number" class="form-control form-control-custom"
                            name="fast_charging_frequency_percent" step="0.1" placeholder="e.g. 5" required>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Average Voltage (V)</label>
                        <input type="number" class="form-control form-control-custom" name="avg_voltage" step="0.1"
                            placeholder="e.g. 3" required>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Internal Resistance (mŒ©)</label>
                        <input type="number" class="form-control form-control-custom" name="internal_resistance_mohm"
                            step="0.01" placeholder="e.g. 11" required>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Capacity Retention (%)</label>
                        <input type="number" class="form-control form-control-custom" name="capacity_retention_percent"
                            step="0.1" placeholder="e.g. 91" required>
                    </div>
                    <div class="col-12 mt-4">
                        <button type="submit" class="btn-predict" style="max-width: 250px;">Run Diagnosis</button>
                    </div>
                </div>
                <!-- Result Area -->
                <div id="predictionResult" class="mt-4 d-none"></div>
            </form>
        </div>

        <!-- Value For Money Form Section -->
        <div id="valueFormSection" class="form-section d-none">
            <div class="form-header">
                <div>
                    <h3 class="fw-bold mb-1">Value Estimation</h3>
                    <p class="text-muted mb-0">Calculate the fair market value of your EV</p>
                </div>
                <button class="btn-close-form" onclick="closeForms()">‚úï</button>
            </div>
            <form id="valueForm">
                <div class="row g-4">
                    <div class="col-md-4">
                        <label class="form-label">Brand</label>
                        <input type="text" class="form-control form-control-custom" name="brand" placeholder="e.g. TVs"
                            required>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Model</label>
                        <input type="text" class="form-control form-control-custom" name="model"
                            placeholder="e.g. TVs iqube" required>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Vehicle Type</label>
                        <select class="form-select form-control-custom" name="vehicle_type">
                            <option value="Car">Car</option>
                            <option value="Bike">Bike</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Initial Battery (kWh)</label>
                        <input type="number" class="form-control form-control-custom"
                            name="initial_battery_capacity_kwh" step="0.1" placeholder="e.g. 3.4" required>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Current Battery (kWh)</label>
                        <input type="number" class="form-control form-control-custom"
                            name="current_battery_capacity_kwh" step="0.1" placeholder="e.g. 2.6" required>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Battery Health (%)</label>
                        <input type="number" class="form-control form-control-custom" name="battery_health_pct"
                            step="0.1" placeholder="e.g. 69.5" required>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Range (km)</label>
                        <input type="number" class="form-control form-control-custom" name="range_km" step="0.1"
                            placeholder="e.g. 145" required>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Top Speed (kmph)</label>
                        <input type="number" class="form-control form-control-custom" name="top_speed_kmph" step="0.1"
                            placeholder="e.g. 82" required>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Odometer (km)</label>
                        <input type="number" class="form-control form-control-custom" name="odometer_km" step="0.1"
                            placeholder="e.g. 67013" required>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Warranty (years)</label>
                        <input type="number" class="form-control form-control-custom" name="warranty_remaining_years"
                            step="0.1" placeholder="e.g. 2" required>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Maintenance Cost</label>
                        <input type="number" class="form-control form-control-custom" name="annual_maintenance_cost"
                            step="0.01" placeholder="e.g. 5855" required>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Purchase Year</label>
                        <input type="number" class="form-control form-control-custom" name="Purchase_Year" min="2000"
                            max="2050" placeholder="e.g. 2019" required>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Current Year</label>
                        <input type="number" class="form-control form-control-custom" name="Current_Year" value="2025"
                            placeholder="e.g. 2026" required>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Purchase Price (Lakhs)</label>
                        <input type="number" class="form-control form-control-custom" name="Purchase_Price_L"
                            step="0.01" placeholder="e.g. 148122" required>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Resale Value (Lakhs)</label>
                        <input type="number" class="form-control form-control-custom" name="Resale_Value_L" step="0.01"
                            placeholder="e.g. 47544" required>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Initial Mileage</label>
                        <input type="number" class="form-control form-control-custom" name="Initial_Mileage" step="0.1"
                            placeholder="e.g. 126" required>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Current Mileage</label>
                        <input type="number" class="form-control form-control-custom" name="Current_Mileage" step="0.1"
                            placeholder="e.g. 108" required>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Initial Performance Score (0-10)</label>
                        <input type="number" class="form-control form-control-custom" name="Initial_Perf" step="0.1"
                            placeholder="e.g. 8.9" required>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Current Performance Score (0-10)</label>
                        <input type="number" class="form-control form-control-custom" name="Current_Perf" step="0.1"
                            placeholder="e.g. 8.0" required>
                    </div>
                    <div class="col-12 mt-4 text-center">
                        <button type="submit" class="btn-predict" style="max-width: 250px;">Calculate Value</button>
                    </div>
                </div>
                <!-- Value Result Area -->
                <div id="valueResult" class="mt-4 p-3 d-none text-center"
                    style="border-radius: 12px; font-weight: bold;"></div>
            </form>
        </div>

        <!-- Sales Forecast Section -->
        <div id="salesFormSection" class="form-section d-none">
            <div class="form-header">
                <div>
                    <h3 class="fw-bold mb-1">EV Sales Forecast</h3>
                    <p class="text-muted mb-0">Historical data and future predictions</p>
                </div>
                <button class="btn-close-form" onclick="closeForms()">‚úï</button>
            </div>

            <div class="row mb-3">
                <div class="col-md-4">
                    <label class="form-label">Duration</label>
                    <div class="input-group">
                        <input type="number" id="forecastSteps" class="form-control form-control-custom" value="12"
                            min="1" max="60">
                    </div>
                    <small class="text-muted" id="durationHint">Enter months (e.g. 12)</small>
                </div>
                <div class="col-md-4">
                    <label class="form-label">Granularity</label>
                    <select class="form-select form-control-custom" id="forecastGranularity"
                        onchange="updateDurationHint()">
                        <option value="monthly" selected>Monthly</option>
                        <option value="yearly">Yearly</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label class="form-label d-none d-md-block">&nbsp;</label>
                    <button class="btn btn-primary w-100" onclick="loadForecast()">Update Forecast</button>
                </div>
            </div>

            <div style="height: 400px; position: relative;">
                <canvas id="salesChart"></canvas>
            </div>

            <div id="salesError" class="alert alert-danger mt-3 d-none"></div>
        </div>


    </main>

    <script type="module">
        import { protectRoute } from "./guard.js";
        import { handleLogout } from "./auth.js";

        // Protect Route
        protectRoute('user', ['Premium Plan']).then(user => {
            console.log("Access Granted:", user.fullName);
        });

        window.logout = handleLogout;

        window.updateDurationHint = function () {
            const gran = document.getElementById('forecastGranularity').value;
            const input = document.getElementById('forecastSteps');
            const hint = document.getElementById('durationHint');

            if (gran === 'yearly') {
                hint.innerText = "Enter years (e.g. 5)";
                if (input.value > 10) input.value = 5; // Reset to reasonable default for years
            } else {
                hint.innerText = "Enter months (e.g. 12)";
                if (input.value < 12) input.value = 12; // Reset to reasonable default for months
            }
        };

        // Toggle Forms
        window.showForm = function (type) {
            // Hide all forms first
            document.getElementById('batteryFormSection').classList.add('d-none');
            document.getElementById('valueFormSection').classList.add('d-none');

            // Show selected form
            if (type === 'battery') {
                document.getElementById('batteryFormSection').classList.remove('d-none');
                // Scroll to form
                document.getElementById('batteryFormSection').scrollIntoView({ behavior: 'smooth', block: 'start' });
            } else if (type === 'value') {
                document.getElementById('valueFormSection').classList.remove('d-none');
                document.getElementById('valueFormSection').scrollIntoView({ behavior: 'smooth', block: 'start' });
            } else if (type === 'sales') {
                document.getElementById('salesFormSection').classList.remove('d-none');
                document.getElementById('salesFormSection').scrollIntoView({ behavior: 'smooth', block: 'start' });
                // Load forecast if not already loaded or just specific call
                loadForecast();
            }
        };

        window.closeForms = function () {
            document.getElementById('batteryFormSection').classList.add('d-none');
            document.getElementById('valueFormSection').classList.add('d-none');
            document.getElementById('salesFormSection').classList.add('d-none');
            // Scroll back to top or cards
            window.scrollTo({ top: 0, behavior: 'smooth' });
        };

        // Handle Battery Health Prediction
        document.getElementById('batteryHealthForm').addEventListener('submit', async function (e) {
            e.preventDefault();

            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData.entries());

            // Read user inputs for display
            const capRetention = parseFloat(data.capacity_retention_percent) || 0;
            const chargeCycles = parseInt(data.total_charge_cycles) || 0;
            const maxTemp = parseFloat(data.max_battery_temperature_c) || 0;
            const fastChargePct = parseFloat(data.fast_charging_frequency_percent) || 0;

            const resultDiv = document.getElementById('predictionResult');
            resultDiv.classList.remove('d-none');
            resultDiv.className = 'mt-4';
            resultDiv.innerHTML = `
                <div class="bh-card visible p-4 text-center mb-3">
                    <div class="spinner-border text-primary" role="status" style="width:3rem;height:3rem;"></div>
                    <p class="mt-3 text-muted fw-semibold">Analyzing battery health...</p>
                </div>`;

            try {
                const response = await fetch('https://ev-4ce7.onrender.com/predict_health', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data),
                });

                if (!response.ok) throw new Error('API request failed');
                const result = await response.json();

                if (result.status === 'success') {
                    const orbColor = { 'Healthy': '#10b981', 'Moderate': '#f59e0b', 'Degraded': '#ef4444' }[result.prediction] || '#6b7280';
                    const orbIcon = { 'Healthy': 'üîã', 'Moderate': '‚ö°', 'Degraded': 'üî¥' }[result.prediction] || 'üîã';
                    const riskMarkerLeft = { 'LOW': '10%', 'MODERATE': '48%', 'HIGH': '86%' }[result.risk_level] || '48%';
                    const riskLabel = { 'LOW': 'üü¢ Low Risk', 'MODERATE': 'üü° Moderate Risk', 'HIGH': 'üî¥ High Risk' }[result.risk_level] || result.risk_level;

                    // Metric bar configs: [label, value, max, color]
                    const metrics = [
                        { label: 'Capacity Retention', value: capRetention, max: 100, color: capRetention > 85 ? '#10b981' : capRetention > 70 ? '#f59e0b' : '#ef4444', unit: '%' },
                        { label: 'Max Temperature', value: maxTemp, max: 80, color: maxTemp < 40 ? '#10b981' : maxTemp < 55 ? '#f59e0b' : '#ef4444', unit: '¬∞C' },
                        { label: 'Charge Cycles', value: Math.min(chargeCycles, 2000), max: 2000, color: chargeCycles < 500 ? '#10b981' : chargeCycles < 1000 ? '#f59e0b' : '#ef4444', unit: ` (${chargeCycles})` },
                        { label: 'Fast Charging Freq', value: fastChargePct, max: 100, color: fastChargePct < 20 ? '#10b981' : fastChargePct < 50 ? '#f59e0b' : '#ef4444', unit: '%' },
                    ];

                    const metricHTML = metrics.map((m, i) => `
                        <div style="margin-bottom: 14px;">
                            <div class="d-flex justify-content-between" style="font-size:0.82rem; font-weight:600; color:#475569;">
                                <span>${m.label}</span>
                                <span style="color:${m.color}">${m.value}${m.unit}</span>
                            </div>
                            <div class="bh-metric-bar">
                                <div class="bh-metric-fill" id="bar-${i}" style="background:${m.color};"></div>
                            </div>
                        </div>`).join('');

                    resultDiv.innerHTML = `
                        <div class="bh-result-wrapper">
                            <!-- Status Orb -->
                            <div class="text-center mb-4">
                                <div class="bh-status-orb" style="background: ${orbColor};">
                                    <div>${orbIcon}</div>
                                    <div class="bh-status-label">${result.prediction}</div>
                                </div>
                                <p class="text-muted" style="font-size:0.9rem;">AI Battery Diagnosis Complete</p>
                            </div>

                            <!-- Metric Bars -->
                            <div class="bh-card mb-3" id="bh-metrics">
                                <h6 class="fw-bold mb-3" style="color:#1e293b;">üìä Key Metrics</h6>
                                ${metricHTML}
                            </div>

                            <!-- Recommendation & Insight -->
                            <div class="row g-3 mb-3">
                                <div class="col-md-6">
                                    <div class="bh-card h-100" id="bh-rec">
                                        <div style="font-size:1.5rem; margin-bottom:8px;">üí°</div>
                                        <h6 class="fw-bold mb-1" style="color:#1e293b;">Recommendation</h6>
                                        <p class="mb-0" style="font-size:0.9rem; color:#64748b; line-height:1.6;">${result.recommendation}</p>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="bh-card h-100" id="bh-insight">
                                        <div style="font-size:1.5rem; margin-bottom:8px;">üî¨</div>
                                        <h6 class="fw-bold mb-1" style="color:#1e293b;">AI Insight</h6>
                                        <p class="mb-0" style="font-size:0.9rem; color:#64748b; line-height:1.6;">${result.insight}</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Risk Meter -->
                            <div class="bh-card" id="bh-risk">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <h6 class="fw-bold mb-0" style="color:#1e293b;">‚ö° Risk Level</h6>
                                    <span style="font-weight:700; font-size:1rem;">${riskLabel}</span>
                                </div>
                                <div style="position:relative; padding: 8px 0 24px;">
                                    <div class="bh-risk-bar"></div>
                                    <div class="bh-risk-marker" id="riskMarker" style="left: 0%;"></div>
                                </div>
                                <div class="d-flex justify-content-between" style="font-size:0.75rem; color:#94a3b8; font-weight:600; margin-top:-16px;">
                                    <span>Low</span><span>Moderate</span><span>High</span>
                                </div>
                            </div>
                        </div>`;

                    // Animate cards in sequence
                    const cards = ['bh-metrics', 'bh-rec', 'bh-insight', 'bh-risk'];
                    cards.forEach((id, i) => {
                        setTimeout(() => {
                            const el = document.getElementById(id);
                            if (el) el.classList.add('visible');
                        }, 150 + i * 120);
                    });

                    // Animate metric bars
                    metrics.forEach((m, i) => {
                        setTimeout(() => {
                            const bar = document.getElementById(`bar-${i}`);
                            if (bar) bar.style.width = `${Math.min((m.value / m.max) * 100, 100)}%`;
                        }, 400 + i * 80);
                    });

                    // Animate risk marker
                    setTimeout(() => {
                        const marker = document.getElementById('riskMarker');
                        if (marker) marker.style.left = riskMarkerLeft;
                    }, 700);

                } else {
                    throw new Error(result.error || 'Unknown error');
                }
            } catch (error) {
                console.error('Error:', error);
                resultDiv.className = 'mt-4 p-3 text-center alert alert-danger';
                resultDiv.innerText = 'Error connecting to prediction server. Please ensure the Python backend is running.';
            }
        });

        // Gauge Chart Instance
        let valueGaugeChart = null;

        document.getElementById('valueForm').addEventListener('submit', async function (e) {
            e.preventDefault();

            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData.entries());

            const resultDiv = document.getElementById('valueResult');
            resultDiv.classList.remove('d-none');
            // Reset classes to be cleaner container
            resultDiv.className = 'mt-4';
            resultDiv.innerHTML = '<div class="alert alert-info">Calculating value...</div>';

            try {
                const response = await fetch('https://ev-4ce7.onrender.com/predict_value', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data),
                });

                if (!response.ok) throw new Error('API request failed');

                const result = await response.json();

                if (result.status === 'success') {
                    // Clear loading
                    resultDiv.innerHTML = '';

                    // 1. Gauge Chart Container
                    const chartContainer = document.createElement('div');
                    chartContainer.className = 'card mb-3 p-3 text-center border-0 shadow-sm';
                    chartContainer.style.background = '#f8fafc';
                    chartContainer.innerHTML = `
                        <h5 class="text-muted mb-1">Value Score</h5>
                        <div style="width: 200px; height: 110px; margin: 0 auto; position: relative;">
                            <canvas id="valueGaugeCanvas"></canvas>
                            <div style="position: absolute; bottom: 0; left: 0; width: 100%; text-align: center; font-weight: bold; font-size: 1.5rem; color: #334155;">
                                ${result.value_score.toFixed(2)}
                            </div>
                        </div>
                        <h4 class="mt-0 fw-bold" style="color: #475569;">${result.recommendation}</h4>
                    `;
                    resultDiv.appendChild(chartContainer);

                    // Render Gauge
                    renderGaugeChart("valueGaugeCanvas", result.value_score);

                    // 2. Fair Price Card
                    if (result.fair_price_range) {
                        const priceCard = document.createElement('div');
                        priceCard.className = 'alert alert-warning d-flex align-items-center justify-content-center gap-2';
                        priceCard.innerHTML = `
                            <span style="font-size: 1.25rem;">üí∞</span>
                            <div>
                                <strong>Estimated Fair Price:</strong> 
                                <span class="fs-5 fw-bold text-dark">${result.fair_price_range}</span>
                            </div>
                        `;
                        resultDiv.appendChild(priceCard);
                    }

                    // 3. Insights Card
                    if (result.insights && result.insights.length > 0) {
                        const insightsCard = document.createElement('div');
                        insightsCard.className = 'card border-0 shadow-sm p-3 mt-3';
                        insightsCard.innerHTML = `
                            <h6 class="fw-bold border-bottom pb-2 mb-2">Analysis Insights</h6>
                            <ul class="list-unstyled text-start mb-0">
                                ${result.insights.map(i => `<li class="mb-2 d-flex gap-2"><span class="text-primary">‚Ä¢</span> ${i}</li>`).join('')}
                            </ul>
                        `;
                        resultDiv.appendChild(insightsCard);
                    }

                } else {
                    throw new Error(result.error || 'Unknown error');
                }
            } catch (error) {
                console.error('Error:', error);
                resultDiv.className = 'mt-4 p-3 text-center alert alert-danger';
                resultDiv.innerText = 'Error connecting to prediction server.';
            }
        });

        function renderGaugeChart(canvasId, score) {
            const ctx = document.getElementById(canvasId).getContext('2d');

            if (valueGaugeChart) {
                valueGaugeChart.destroy();
            }

            // Map score (approx 0.5 to 1.5) to gauge
            // red: 0-0.9, yellow: 0.9-1.0, green: >1.0
            // We'll create a simple semi-circle gauge

            // Background gray
            const data = {
                labels: ["Score", "Remaining"],
                datasets: [{
                    data: [score, 2.0 - score], // Check max scale
                    backgroundColor: [
                        score >= 1.0 ? '#10b981' : (score >= 0.9 ? '#f59e0b' : '#ef4444'),
                        '#e2e8f0'
                    ],
                    borderWidth: 0,
                    circumference: 180,
                    rotation: 270,
                    cutout: '80%'
                }]
            };

            valueGaugeChart = new Chart(ctx, {
                type: 'doughnut',
                data: data,
                options: {
                    responsive: true,
                    aspectRatio: 2,
                    cutout: '80%',
                    plugins: {
                        legend: { display: false },
                        tooltip: { enabled: false }
                    }
                }
            });
        }

        // Handle Sales Forecast
        let salesChart = null;

        window.loadForecast = async function () {
            const steps = document.getElementById('forecastSteps').value;
            const granularity = document.getElementById('forecastGranularity').value;
            const errorDiv = document.getElementById('salesError');
            errorDiv.classList.add('d-none');

            try {
                const response = await fetch(`https://ev-4ce7.onrender.com/predict_sales?steps=${steps}&granularity=${granularity}`);
                if (!response.ok) throw new Error('Failed to fetch forecast');

                const result = await response.json();

                if (result.status === 'success') {
                    renderSalesChart(result.forecast);
                } else {
                    throw new Error(result.error);
                }
            } catch (error) {
                console.error('Error:', error);
                errorDiv.innerText = 'Error loading forecast: ' + error.message;
                errorDiv.classList.remove('d-none');
            }
        };

        function renderSalesChart(forecastData) {
            const ctx = document.getElementById('salesChart').getContext('2d');

            if (salesChart) {
                salesChart.destroy();
            }

            salesChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: forecastData.dates,
                    datasets: [
                        {
                            label: 'Forecasted Sales',
                            data: forecastData.values,
                            borderColor: '#6366f1',
                            backgroundColor: 'rgba(99, 102, 241, 0.1)',
                            borderWidth: 2,
                            fill: false,
                            tension: 0.4
                        },
                        {
                            label: 'Confidence Interval (Upper)',
                            data: forecastData.upper_ci,
                            borderColor: 'rgba(99, 102, 241, 0.2)',
                            backgroundColor: 'rgba(99, 102, 241, 0)',
                            borderWidth: 1,
                            borderDash: [5, 5],
                            pointRadius: 0,
                            fill: false
                        },
                        {
                            label: 'Confidence Interval (Lower)',
                            data: forecastData.lower_ci,
                            borderColor: 'rgba(99, 102, 241, 0.2)',
                            backgroundColor: 'rgba(99, 102, 241, 0.1)',
                            borderWidth: 1,
                            borderDash: [5, 5],
                            pointRadius: 0,
                            fill: '-1' // Fill to previous dataset
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        title: {
                            display: true,
                            text: 'EV Sales Forecast'
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            title: {
                                display: true,
                                text: 'EV Units Sold'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Date'
                            }
                        }
                    },
                    interaction: {
                        mode: 'nearest',
                        axis: 'x',
                        intersect: false
                    }
                }
            });
        }

    </script>

</body>

</html>